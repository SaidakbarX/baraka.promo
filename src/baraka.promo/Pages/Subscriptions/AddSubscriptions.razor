@page "/add_subscription"

@using Microsoft.EntityFrameworkCore;
@using baraka.promo.Data.Subscriptions;
@using baraka.promo.Services

@inject IJSRuntime jsRuntime
@inject ApplicationDbContext _dbApp
@inject NotificationService NotificationService
@inject ILogger<AddSubscriptions> _logger
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment _env

<RadzenMenu Style="display:flex; justify-content:space-between; background-color:lightgray;" @attributes="@(new Dictionary<string, object>() { { "class", "header-menu-btn-toolbar" } })">
    <div style="display:flex; align-items:center; background-color:lightgray; width: 100%; padding: 0px 35px 0px 8px;">
    </div>
</RadzenMenu>

<div style="display: flex; gap: 20px;">
    <RadzenCard Style="display: flex; row-gap: 15px; flex-direction: column; width: 100%;">
        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2">Основная информация</RadzenText>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Идентификатор продукта *</RadzenText>
                <RadzenTextBox @bind-Value="@model.ProductId" Placeholder="Идентификатор продукта" class="w-100" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Идентификатор акции</RadzenText>
                <RadzenTextBox @bind-Value="@model.PromotionId" Placeholder="Идентификатор продукта" class="w-100" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Имя группы *</RadzenText>
                <RadzenDropDown @bind-Value="@model.NameRu"
                                Data="@availableNameRus"
                                Placeholder="Имя группы"
                                class="w-100"
                                AllowFiltering="true"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />
            </div>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Цена *</RadzenText>
                <RadzenNumeric @bind-Value="@model.Price" class="w-100" Format="N2" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">НДС (%) *</RadzenText>
                <RadzenNumeric @bind-Value="@model.Vat" class="w-100" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Максимальное количество *</RadzenText>
                <RadzenNumeric @bind-Value="@model.MaxCount" class="w-100" />
            </div>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Код пакета *</RadzenText>
                <RadzenTextBox @bind-Value="@model.PackageCode" Placeholder="Код пакета" class="w-100" MaxLength="20" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Код устройства</RadzenText>
                <RadzenTextBox @bind-Value="@model.UnitCode" Placeholder="Код устройства" class="w-100" MaxLength="20" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">MXIK *</RadzenText>
                <RadzenTextBox @bind-Value="@model.MXIK" Placeholder="MXIK" class="w-100" MaxLength="50" />
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Идентификатор страны*</RadzenText>
                <RadzenNumeric @bind-Value="@model.CountryId" Placeholder="Идентификатор страны" class="w-100" />
            </div>
            <div style="flex: 1;"></div>
            <div style="flex: 1;"></div>
        </div>



        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Имена</RadzenText>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">ИмяUz</RadzenText>
                <RadzenTextBox @bind-Value="@model.NameUz" Placeholder="ИмяUz " class="w-100" MaxLength="400" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">ИмяRu </RadzenText>
                <RadzenTextBox @bind-Value="@model.NameRu" Placeholder="ИмяRu" class="w-100" MaxLength="400" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">ИмяEn</RadzenText>
                <RadzenTextBox @bind-Value="@model.NameEn" Placeholder="ИмяEn" class="w-100"
                               MaxLength="400" />
            </div>
        </div>

        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">
            Краткое содержание
        </RadzenText>


        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Короткий контент_Uz </RadzenText>
                <RadzenTextArea @bind-Value="@model.ShortContent_Uz" Placeholder="Короткий контент_Uz " class="w-100" Style="height: 80px" MaxLength="600" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">
                    Короткий контент_Ru
                </RadzenText>
                <RadzenTextArea @bind-Value="@model.ShortContent_Ru" Placeholder="Короткий контент_Ru" class="w-100" Style="height: 80px" MaxLength="600" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Короткий контентt_En</RadzenText>
                <RadzenTextArea @bind-Value="@model.ShortContent_En"
                                Placeholder="Короткий контент"
                                class="w-100"
                                Style="height: 80px"
                                MaxLength="600" />
            </div>
        </div>

        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Полный cодержание</RadzenText>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Содержание_Uz </RadzenText>
                <RadzenTextArea @bind-Value="@model.Content_Uz" Placeholder="Содержание_Uz " class="w-100" Style="height: 120px" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Содержание_Ru </RadzenText>
                <RadzenTextArea @bind-Value="@model.Content_Ru" Placeholder="Содержание_Ru " class="w-100" Style="height: 120px" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Содержание_En </RadzenText>
                <RadzenTextArea @bind-Value="@model.Content_En" Placeholder="Содержание_En " class="w-100" Style="height: 120px" />
            </div>
        </div>



        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 30px;">Информация о покупке</RadzenText>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">ИмяПокупкаUz </RadzenText>
                <RadzenTextBox @bind-Value="@model.NamePurchaseUz" Placeholder="ИмяПокупкаUz " class="w-100" MaxLength="400" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">ИмяПокупкаRu </RadzenText>
                <RadzenTextBox @bind-Value="@model.NamePurchaseRu" Placeholder="ИмяПокупкаRu " class="w-100" MaxLength="400" />
            </div>
            <div style="flex: 1;">

                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">ИмяПокупкаEn</RadzenText>
                <RadzenTextBox @bind-Value="@model.NamePurchaseEn" Placeholder="ИмяПокупкаEn" class="w-100" MaxLength="400" />
            </div>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">КороткийКонтент_Покупка_Uz </RadzenText>
                <RadzenTextArea @bind-Value="@model.ShortContent_Purchase_Uz" Placeholder="КороткийКонтент_Покупка_Uz " class="w-100" Style="height: 80px" MaxLength="600" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">КороткийКонтент_Покупка_Ru</RadzenText>
                <RadzenTextArea @bind-Value="@model.ShortContent_Purchase_Ru" Placeholder="КороткийКонтент_Покупка_Ru" class="w-100" Style="height: 80px" MaxLength="600" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">КороткийКонтент_Покупка_En </RadzenText>
                <RadzenTextArea @bind-Value="@model.ShortContent_Purchase_En" Placeholder="КороткийКонтент_Покупка_En" class="w-100" Style="height: 80px" MaxLength="600" />
            </div>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Покупка_контентаUz </RadzenText>
                <RadzenTextArea @bind-Value="@model.Content_Purchase_Uz" Placeholder="Покупка_контентаUz " class="w-100" Style="height: 120px" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Покупка_контентаRu </RadzenText>
                <RadzenTextArea @bind-Value="@model.Content_Purchase_Ru" Placeholder="Покупка_контентаRu" class="w-100" Style="height: 120px" />
            </div>

            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Покупка_контентаEn </RadzenText>
                <RadzenTextArea @bind-Value="@model.Content_Purchase_En" Placeholder="Покупка_контентаEn" class="w-100" Style="height: 120px" />
            </div>
        </div>
        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Фотографии покупок</RadzenText>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Fayl tanlanmagan"
                           readonly
                           value="@fileNamePurchaseUz" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "purchase_uz"))"
                                   accept="image/*"
                                   style="display: none;" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(previewPurchaseUz))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewPurchaseUz"
                                     Style="width: 100%; height: 350px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                                     AlternateText="Purchase UZ" />
                    </div>
                }
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Файл не выбран"
                           readonly
                           value="@fileNamePurchaseRu" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "purchase_ru"))"
                                   accept="image/*"
                                   style="display: none;" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(previewPurchaseRu))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewPurchaseRu"
                                     Style="width: 100%; height: 350px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                                     AlternateText="Purchase RU" />
                    </div>
                }
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="No file selected"
                           readonly
                           value="@fileNamePurchaseEn" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "purchase_en"))"
                                   accept="image/*"
                                   style="display: none;" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(previewPurchaseEn))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewPurchaseEn"
                                     Style="width: 100%; height: 350px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                                     AlternateText="Purchase EN" />
                    </div>
                }
            </div>
        </div>



        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Картинки</RadzenText>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Fayl tanlanmagan"
                           readonly
                           value="@fileNameUz" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "uz"))"
                                   accept="image/*"
                                   style="display: none;" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(previewUz))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewUz"
                                     Style="width: 100%; height: 350px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                                     AlternateText="File UZ" />
                    </div>
                }
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Файл не выбран"
                           readonly
                           value="@fileNameRu" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "ru"))"
                                   accept="image/*"
                                   style="display: none;" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(previewRu))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewRu"
                                     Style="width: 100%; height: 350px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                                     AlternateText="File RU" />
                    </div>
                }
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="No file selected"
                           readonly
                           value="@fileNameEn" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "en"))"
                                   accept="image/*"
                                   style="display: none;" />
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(previewEn))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewEn"
                                     Style="width: 100%; height: 350px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                                     AlternateText="File EN" />
                    </div>
                }
            </div>
        </div>



        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <RadzenCheckBox @bind-Value="@model.IsActive" Name="isActive" />
            <RadzenLabel Text="IsActive" Component="isActive" />
        </div>

        <div style="display: flex; margin-left: auto; column-gap: 10px; margin-top: 20px;">
            @if (loadingSave)
            {
                <div>
                    <RadzenProgressBarCircular Style="margin-left: 60px" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                </div>
            }
            <RadzenButton Disabled="@disableSave" Variant="Variant.Flat" Click=@Save Text="Сохранять" ButtonStyle="ButtonStyle.Success" Style="width: 150px" />
            <RadzenButton Click=@Cancel Text="Отмена" ButtonStyle="ButtonStyle.Secondary" Style="width: 150px" />
        </div>
    </RadzenCard>
</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState>? AuthTask { get; set; }

    bool disableSave = false;
    bool loadingSave = false;

    string fileNameUz = "Select a file Uz";
    string fileNameRu = "Select a file Ru";
    string fileNameEn = "Select a file En";
    string fileNamePurchaseUz = "Select a file Purchase Uz";
    string fileNamePurchaseRu = "Select a file Purchase Ru";
    string fileNamePurchaseEn = "Select a file Purchase En";

    long imageMaxSize = 10240 * 1024;

    InputFileStream? imageFileUz;
    InputFileStream? imageFileRu;
    InputFileStream? imageFileEn;
    InputFileStream? imageFilePurchaseUz;
    InputFileStream? imageFilePurchaseRu;
    InputFileStream? imageFilePurchaseEn;
    private string? previewPurchaseUz, previewPurchaseRu, previewPurchaseEn;
    private string? previewUz, previewRu, previewEn;
    AddSubscriptionModel model = new();

    private List<string > availableNameRus = new();

    protected override async Task OnInitializedAsync()
    {
        model.IsActive = true;
        model.CreatedTime = DateTime.Now;
        await LoadNameRus();
    }

    private async Task LoadNameRus()
    {
        try
        {
            availableNameRus = await _dbApp.SubscriptionGroups
                .OrderByDescending(g => g.NameRu ?? g.NameUz ?? g.NameEn) 
                .Select(g =>
                    !string.IsNullOrEmpty(g.NameRu) ? g.NameRu :
                    !string.IsNullOrEmpty(g.NameUz) ? g.NameUz :
                    g.NameEn
                )
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading name russ");
            availableNameRus = new List<string>();
        }
    }


    async Task OnInputFileChange(InputFileChangeEventArgs e, string type)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            string extension = Path.GetExtension(file.Name);

            if (!IsImageExtension(extension))
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Ошибка",
                    Detail = "Можно загружать только файлы изображений.",
                    Duration = 4000
                });
                return;
            }

            if (file.Size > imageMaxSize)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Ошибка",
                    Detail = $"Размер файла {imageMaxSize / 1024 / 1024} Не должно превышать МБ",
                    Duration = 4000
                });
                return;
            }

            MemoryStream fileStream = new MemoryStream();
            await using (var input = file.OpenReadStream(imageMaxSize))
            {
                await input.CopyToAsync(fileStream);
            }

            fileStream.Position = 0;
            if (fileStream.Length > 0)
            {
                string fileName = $"{Guid.NewGuid()}{extension}".Replace("-", "").ToLower();
                var inputFile = new InputFileStream(fileStream, fileName);
                var bytes = fileStream.ToArray();
                var base64 = $"data:image/png;base64,{Convert.ToBase64String(bytes)}";
                switch (type)
                {
                    case "uz":
                        imageFileUz = inputFile;
                        fileNameUz = fileName;
                        previewUz = base64;
                        break;
                    case "ru":
                        imageFileRu = inputFile;
                        fileNameRu = fileName;
                        previewRu = base64;
                        break;
                    case "en":
                        imageFileEn = inputFile;
                        fileNameEn = fileName;
                        previewEn = base64;
                        break;
                    case "purchase_uz":
                        imageFilePurchaseUz = inputFile;
                        fileNamePurchaseUz = fileName;
                        previewPurchaseUz = base64;
                        break;
                    case "purchase_ru":
                        imageFilePurchaseRu = inputFile;
                        fileNamePurchaseRu = fileName;
                        previewPurchaseRu = base64;
                        break;
                    case "purchase_en":
                        imageFilePurchaseEn = inputFile;
                        fileNamePurchaseEn = fileName;
                        previewPurchaseEn = base64;
                        break;
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Ошибка",
                Detail = ex.Message,
                Duration = 4000
            });
            _logger.LogError(ex, "Error uploading file");
        }
    }

    async Task Save()
    {
        try
        {
            loadingSave = true;
            disableSave = true;
            StateHasChanged();

            // Validation
            if (string.IsNullOrWhiteSpace(model.NameUz) ||
                string.IsNullOrWhiteSpace(model.ProductId) ||
                string.IsNullOrWhiteSpace(model.NamePurchaseUz) ||
                string.IsNullOrWhiteSpace(model.MXIK) ||
                string.IsNullOrWhiteSpace(model.PackageCode))
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Предупреждение",
                    Detail = "Заполните обязательные поля.",
                    Duration = 4000
                });
                loadingSave = false;
                disableSave = false;
                StateHasChanged();
                return;
            }

            // Save images to folder
            string folderPath = Path.Combine(_env.WebRootPath, "img");

            if (!Directory.Exists(folderPath))
            {
                Directory.CreateDirectory(folderPath);
            }

            if (imageFileUz != null)
            {
                string filePath = Path.Combine(folderPath, imageFileUz.FileName);
                await SaveImageFile(imageFileUz, filePath);
                model.ImageUrlUz = imageFileUz.FileName;
            }

            if (imageFileRu != null)
            {
                string filePath = Path.Combine(folderPath, imageFileRu.FileName);
                await SaveImageFile(imageFileRu, filePath);
                model.ImageUrlRu = imageFileRu.FileName;
            }

            if (imageFileEn != null)
            {
                string filePath = Path.Combine(folderPath, imageFileEn.FileName);
                await SaveImageFile(imageFileEn, filePath);
                model.ImageUrlEn = imageFileEn.FileName;
            }

            if (imageFilePurchaseUz != null)
            {
                string filePath = Path.Combine(folderPath, imageFilePurchaseUz.FileName);
                await SaveImageFile(imageFilePurchaseUz, filePath);
                model.ImageUrl_Purchase_Uz = imageFilePurchaseUz.FileName;
            }

            if (imageFilePurchaseRu != null)
            {
                string filePath = Path.Combine(folderPath, imageFilePurchaseRu.FileName);
                await SaveImageFile(imageFilePurchaseRu, filePath);
                model.ImageUrl_Purchase_Ru = imageFilePurchaseRu.FileName;
            }

            if (imageFilePurchaseEn != null)
            {
                string filePath = Path.Combine(folderPath, imageFilePurchaseEn.FileName);
                await SaveImageFile(imageFilePurchaseEn, filePath);
                model.ImageUrl_Purchase_En = imageFilePurchaseEn.FileName;
            }

            // Save to database
            var subscription = new Subscription
            {
                NameUz = model.NameUz,
                NameRu = model.NameRu,
                NameEn = model.NameEn,
                ProductId = model.ProductId,
                MaxCount = model.MaxCount,
                IsActive = model.IsActive,
                CountryId = model.CountryId,
                ShortContent_Ru = model.ShortContent_Ru,
                ShortContent_Uz = model.ShortContent_Uz,
                ShortContent_En = model.ShortContent_En,
                Content_Ru = model.Content_Ru,
                Content_Uz = model.Content_Uz,
                Content_En = model.Content_En,
                CreatedTime = model.CreatedTime,
                ImageUrlRu = model.ImageUrlRu,
                ImageUrlUz = model.ImageUrlUz,
                ImageUrlEn = model.ImageUrlEn,
                GroupId = model.GroupId,
                Price = model.Price,
                MXIK = model.MXIK,
                PackageCode = model.PackageCode,
                Vat = model.Vat,
                UnitCode = model.UnitCode,
                NamePurchaseUz = model.NamePurchaseUz,
                NamePurchaseEn = model.NamePurchaseEn,
                NamePurchaseRu = model.NamePurchaseRu,
                ShortContent_Purchase_Ru = model.ShortContent_Purchase_Ru,
                ShortContent_Purchase_Uz = model.ShortContent_Purchase_Uz,
                ShortContent_Purchase_En = model.ShortContent_Purchase_En,
                Content_Purchase_Ru = model.Content_Purchase_Ru,
                Content_Purchase_Uz = model.Content_Purchase_Uz,
                Content_Purchase_En = model.Content_Purchase_En,
                ImageUrl_Purchase_Ru = model.ImageUrl_Purchase_Ru,
                ImageUrl_Purchase_Uz = model.ImageUrl_Purchase_Uz,
                ImageUrl_Purchase_En = model.ImageUrl_Purchase_En,
                PromotionId = model.PromotionId
            };

            await _dbApp.Subscriptions.AddAsync(subscription);
            await _dbApp.SaveChangesAsync();

            _logger.LogInformation($"Subscription created by {AuthTask?.Result.User.Identity?.Name}");

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Успех",
                Detail = "Подписка успешно сохранена",
                Duration = 4000
            });

            NavigationManager.NavigateTo("/subscriptions");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Ошибка",
                Detail = ex.Message,
                Duration = 4000
            });
            _logger.LogError(ex, "Ошибка сохранения подписки.");
        }
        finally
        {
            loadingSave = false;
            disableSave = false;
            StateHasChanged();
        }
    }

    async Task SaveImageFile(InputFileStream inputFile, string filePath)
    {
        using (var fileStream = System.IO.File.Create(filePath))
        {
            inputFile.Content.Seek(0, SeekOrigin.Begin);
            await inputFile.Content.CopyToAsync(fileStream);
        }
    }

    void Cancel()
    {
        NavigationManager.NavigateTo("/subscriptions");
    }

    Task Refresh()
    {
        StateHasChanged();
        return Task.CompletedTask;
    }

    private static bool IsImageExtension(string extension)
    {
        extension = extension.ToLower();
        string[] imageExtensions = { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".jfif" };
        return Array.Exists(imageExtensions, ext => ext == extension);
    }

    public class AddSubscriptionModel
    {
        public string NameUz { get; set; }
        public string ProductId { get; set; }
        public int MaxCount { get; set; }
        public bool IsActive { get; set; }
        public string? NameEn { get; set; }
        public string? NameRu { get; set; }
        public int CountryId { get; set; }
        public string? ShortContent_Ru { get; set; }
        public string? ShortContent_Uz { get; set; }
        public string? ShortContent_En { get; set; }
        public string? Content_Ru { get; set; }
        public string? Content_Uz { get; set; }
        public string? Content_En { get; set; }
        public DateTime CreatedTime { get; set; }
        public string? ImageUrlRu { get; set; }
        public string? ImageUrlUz { get; set; }
        public string? ImageUrlEn { get; set; }
        public long GroupId { get; set; }
        public decimal Price { get; set; }
        public string MXIK { get; set; }
        public string PackageCode { get; set; }
        public int Vat { get; set; }
        public string? UnitCode { get; set; }
        public string NamePurchaseUz { get; set; }
        public string? NamePurchaseEn { get; set; }
        public string? NamePurchaseRu { get; set; }
        public string? ShortContent_Purchase_Ru { get; set; }
        public string? ShortContent_Purchase_Uz { get; set; }
        public string? ShortContent_Purchase_En { get; set; }
        public string? Content_Purchase_Ru { get; set; }
        public string? Content_Purchase_Uz { get; set; }
        public string? Content_Purchase_En { get; set; }
        public string? ImageUrl_Purchase_Ru { get; set; }
        public string? ImageUrl_Purchase_Uz { get; set; }
        public string? ImageUrl_Purchase_En { get; set; }
        public string? PromotionId { get; set; }
    }

    public class InputFileStream
    {
        public Stream Content { get; set; }
        public string FileName { get; set; }

        public InputFileStream(Stream content, string fileName)
        {
            Content = content;
            FileName = fileName;
        }
    }
}