@page "/add_subscription_notification"

@using Microsoft.EntityFrameworkCore
@using baraka.promo.Data.Subscriptions
@using baraka.promo.Models.Enums
@using baraka.promo.Utils
@using baraka.promo.Data.PromoEntities

@inject IJSRuntime JSRuntime
@inject ApplicationDbContext Db
@inject DeliveryDbContext DbDelivery
@inject NotificationService Notify
@inject ILogger<AddSubscriptionNotification> Logger
@inject NavigationManager Nav
@inject IWebHostEnvironment Env

<RadzenMenu Style="display:flex; justify-content:space-between; background-color:lightgray;">
    <div style="display:flex; align-items:center; background-color:lightgray; width: 100%; padding: 0px 35px 0px 8px;">
    </div>
</RadzenMenu>

<div style="display: flex; gap: 20px; max-height: calc(100vh - 100px); overflow-y: auto; padding: 20px;">
    <RadzenCard Style="display: flex; row-gap: 15px; flex-direction: column; width: 100%;">
        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2">Основная информация</RadzenText>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1; max-width: 33%;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Тип </RadzenText>
                <RadzenDropDown @bind-Value="@model.NotificationType"
                                Data="@availableTypes"
                                TextProperty="Value"
                                ValueProperty="Key"
                                Placeholder="Выберите тип"
                                Change="@OnTypeChanged"
                                class="w-100" />
            </div>

            @if (model.NotificationType == InapType.Category)
            {
                <div style="flex: 1; max-width: 33%;" @key="@($"category-{dropdownKey}")">
                    <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Выберите группу  </RadzenText>
                    <RadzenDropDown TValue="Guid?"
                                    @bind-Value="@selectedCategoryId"
                                    Data="@promoGroups"
                                    TextProperty="Name_Ru"
                                    ValueProperty="Id"
                                    Placeholder="Выберите группу"
                                    class="w-100"
                                    AllowFiltering="true"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    AllowClear="true" />
                </div>
            }
            else if (model.NotificationType == InapType.Product)
            {
                <div style="flex: 1; max-width: 33%;" @key="@($"product-{dropdownKey}")">
                    <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Выберите продукт </RadzenText>
                    <RadzenDropDown TValue="Guid?"
                                    @bind-Value="@selectedProductId"
                                    Data="@products"
                                    TextProperty="Name_Ru"
                                    ValueProperty="Id"
                                    Placeholder="Выберите продукт"
                                    class="w-100"
                                    AllowFiltering="true"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    AllowClear="true" />
                </div>
            }
        </div>

        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Названия</RadzenText>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Названия Uz *</RadzenText>
                <RadzenTextBox @bind-Value="@model.NotificationTitleUz" Placeholder="Названия Uz" class="w-100" MaxLength="400" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Названия Ru</RadzenText>
                <RadzenTextBox @bind-Value="@model.NotificationTitleRu" Placeholder="Названия Ru" class="w-100" MaxLength="400" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Названия En</RadzenText>
                <RadzenTextBox @bind-Value="@model.NotificationTitleEn" Placeholder="Названия En" class="w-100" MaxLength="400" />
            </div>
        </div>

        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Описание</RadzenText>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Описание Uz</RadzenText>
                <RadzenTextArea @bind-Value="@model.NotificationDescriptionUz" Placeholder="Описание Uz" class="w-100" Style="height: 80px" MaxLength="600" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Описание Ru</RadzenText>
                <RadzenTextArea @bind-Value="@model.NotificationDescriptionRu" Placeholder="Описание Ru" class="w-100" Style="height: 80px" MaxLength="600" />
            </div>
            <div style="flex: 1;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Описание En</RadzenText>
                <RadzenTextArea @bind-Value="@model.NotificationDescriptionEn" Placeholder="Описание En" class="w-100" Style="height: 80px" MaxLength="600" />
            </div>
        </div>

        <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin-top: 20px;">Изображения </RadzenText>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Изображение UZ</RadzenText>
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="No file selected" readonly value="@fileNameUz" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "uz"))" accept="image/*" style="display: none;" />
                    </label>
                </div>
                @if (!string.IsNullOrEmpty(previewUz))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewUz" Style="width: 100%; height: 250px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);" AlternateText="Preview UZ" />
                    </div>
                }
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Изображение RU</RadzenText>
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="No file selected" readonly value="@fileNameRu" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "ru"))" accept="image/*" style="display: none;" />
                    </label>
                </div>
                @if (!string.IsNullOrEmpty(previewRu))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewRu" Style="width: 100%; height: 250px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);" AlternateText="Preview RU" />
                    </div>
                }
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Изображение EN</RadzenText>
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="No file selected" readonly value="@fileNameEn" />
                    <label class="btn btn-primary mb-0">
                        Browse
                        <InputFile OnChange="@((e) => OnInputFileChange(e, "en"))" accept="image/*" style="display: none;" />
                    </label>
                </div>
                @if (!string.IsNullOrEmpty(previewEn))
                {
                    <div class="mt-3">
                        <RadzenImage Path="@previewEn" Style="width: 100%; height: 250px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);" AlternateText="Preview EN" />
                    </div>
                }
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <RadzenCheckBox @bind-Value="@model.IsNotificationActive" Name="isActive" />
            <RadzenLabel Text="Активно" Component="isActive" />
        </div>

        <div style="display: flex; margin-left: auto; column-gap: 10px; margin-top: 20px;">
            @if (loadingSave)
            {
                <div>
                    <RadzenProgressBarCircular Style="margin-left: 60px" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                </div>
            }
            <RadzenButton Disabled="@disableSave" Variant="Variant.Flat" Click=@Save Text="Сохранить" ButtonStyle="ButtonStyle.Success" Style="width: 150px" />
            <RadzenButton Click=@Cancel Text="Отмена" ButtonStyle="ButtonStyle.Secondary" Style="width: 150px" />
        </div>
    </RadzenCard>
</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState>? AuthTask { get; set; }

    bool disableSave = false;
    bool loadingSave = false;

    string? fileNameUz = "Select a file";
    string? fileNameRu = "Select a file";
    string? fileNameEn = "Select a file";
    long imageMaxSize = 10240 * 1024;

    InputFileStream? imageFileUz;
    InputFileStream? imageFileRu;
    InputFileStream? imageFileEn;

    private string? previewUz;
    private string? previewRu;
    private string? previewEn;

    AddNotificationModel model = new();
    List<KeyValuePair<InapType, string>> availableTypes = new();
    List<ProductCategory> promoGroups = new();
    List<Product> products = new();
    Guid? selectedCategoryId;
    Guid? selectedProductId;
    bool _disposed;

    int dropdownKey = 0;

    protected override async Task OnInitializedAsync()
    {
        model.IsNotificationActive = true;
        model.NotificationType = InapType.None;

        availableTypes = Enum.GetValues<InapType>()
            .Select(t => new KeyValuePair<InapType, string>(
                t,
                EnumHelper<InapType>.EnumToString(t)))
            .ToList();

        await LoadPromoGroups();
        await LoadProducts();
    }

    public void Dispose()
    {
        _disposed = true;
    }

    async Task LoadPromoGroups()
    {
        promoGroups = await DbDelivery.ProductCategories
            .Where(g => !g.IsDeleted)
            .OrderBy(g => g.Name_Ru)
            .ToListAsync();
    }

    async Task LoadProducts()
    {
        products = await DbDelivery.Products
            .Where(p => !p.IsDeleted)
            .OrderBy(p => p.Name_Ru)
            .ToListAsync();
    }

    async Task OnTypeChanged(object value)
    {
        selectedCategoryId = null;
        selectedProductId = null;

        dropdownKey++;

        await InvokeAsync(StateHasChanged);
    }

    async Task OnInputFileChange(InputFileChangeEventArgs e, string type)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            string extension = Path.GetExtension(file.Name);

            if (!IsImageExtension(extension))
            {
                Notify.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Ошибка",
                    Detail = "Можно загружать только файлы изображений.",
                    Duration = 4000
                });
                return;
            }

            if (file.Size > imageMaxSize)
            {
                Notify.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Ошибка",
                    Detail = $"Размер файла не должен превышать {imageMaxSize / 1024 / 1024} МБ",
                    Duration = 4000
                });
                return;
            }

            MemoryStream fileStream = new MemoryStream();
            await using (var input = file.OpenReadStream(imageMaxSize))
            {
                await input.CopyToAsync(fileStream);
            }

            fileStream.Position = 0;
            if (fileStream.Length > 0)
            {
                string generatedFileName = $"{Guid.NewGuid()}{extension}".Replace("-", "").ToLower();
                var inputFile = new InputFileStream(fileStream, generatedFileName);
                var bytes = fileStream.ToArray();
                var preview = $"data:image/png;base64,{Convert.ToBase64String(bytes)}";

                switch (type)
                {
                    case "uz":
                        imageFileUz = inputFile;
                        fileNameUz = generatedFileName;
                        previewUz = preview;
                        break;
                    case "ru":
                        imageFileRu = inputFile;
                        fileNameRu = generatedFileName;
                        previewRu = preview;
                        break;
                    case "en":
                        imageFileEn = inputFile;
                        fileNameEn = generatedFileName;
                        previewEn = preview;
                        break;
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Notify.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Ошибка",
                Detail = ex.Message,
                Duration = 4000
            });
            Logger.LogError(ex, "Error uploading file");
        }
    }

    async Task Save()
    {
        try
        {
            loadingSave = true;
            disableSave = true;
            StateHasChanged();

            if (string.IsNullOrWhiteSpace(model.NotificationTitleUz))
            {
                Notify.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Предупреждение",
                    Detail = "Заполните обязательные поля (Uz).",
                    Duration = 4000
                });
                loadingSave = false;
                disableSave = false;
                StateHasChanged();
                return;
            }

            if (model.NotificationType == InapType.Category && string.IsNullOrWhiteSpace(selectedCategoryId?.ToString()))
            {
                Notify.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Предупреждение",
                    Detail = "Выберите категорию.",
                    Duration = 4000
                });

                loadingSave = false;
                disableSave = false;
                StateHasChanged();
                return;
            }

            if (model.NotificationType == InapType.Product && !selectedProductId.HasValue)
            {
                Notify.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Предупреждение",
                    Detail = "Выберите продукт.",
                    Duration = 4000
                });
                loadingSave = false;
                disableSave = false;
                StateHasChanged();
                return;
            }

            string folderPath = Path.Combine(Env.WebRootPath, "img");
            if (!Directory.Exists(folderPath))
            {
                Directory.CreateDirectory(folderPath);
            }

            if (imageFileUz != null)
            {
                string filePath = Path.Combine(folderPath, imageFileUz.FileName);
                await SaveImageFile(imageFileUz, filePath);
                model.NotificationImageUrlUz = imageFileUz.FileName;
            }

            if (imageFileRu != null)
            {
                string filePath = Path.Combine(folderPath, imageFileRu.FileName);
                await SaveImageFile(imageFileRu, filePath);
                model.NotificationImageUrlRu = imageFileRu.FileName;
            }

            if (imageFileEn != null)
            {
                string filePath = Path.Combine(folderPath, imageFileEn.FileName);
                await SaveImageFile(imageFileEn, filePath);
                model.NotificationImageUrlEn = imageFileEn.FileName;
            }

            var subscription = new Subscription
            {
                MaxCount = 0,
                CountryId = 1,
                GroupId = 0,
                Price = 0,
                MXIK = "notification",
                PackageCode = "notification",
                Vat = 0,
                CreatedTime = DateTime.Now,

                InapType = model.NotificationType,
                NameUz = model.NotificationTitleUz,
                NameRu = model.NotificationTitleRu,
                NameEn = model.NotificationTitleEn,
                Content_Uz = model.NotificationDescriptionUz,
                Content_Ru = model.NotificationDescriptionRu,
                Content_En = model.NotificationDescriptionEn,
                ImageUrlUz = model.NotificationImageUrlUz,
                ImageUrlRu = model.NotificationImageUrlRu,
                ImageUrlEn = model.NotificationImageUrlEn,
                IsActive = model.IsNotificationActive,

                NamePurchaseUz = !string.IsNullOrWhiteSpace(model.NotificationTitleUz)
                       ? model.NotificationTitleUz
                       : "Без названия",
            };

            if (model.NotificationType == InapType.Product && selectedProductId.HasValue)
            {
                subscription.ProductId = selectedProductId.Value.ToString();
            }
            else if (model.NotificationType == InapType.Category && selectedCategoryId.HasValue)
            {
                subscription.ProductId = selectedCategoryId.Value.ToString();
            }

            await Db.Subscriptions.AddAsync(subscription);
            await Db.SaveChangesAsync();

            Logger.LogInformation($"Notification created by {AuthTask?.Result.User.Identity?.Name}");

            Notify.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Успех",
                Detail = "Уведомление успешно сохранено",
                Duration = 4000
            });

            Nav.NavigateTo("/subscription_notifications");
        }
        catch (Exception ex)
        {
            Notify.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Ошибка",
                Detail = ex.Message,
                Duration = 4000
            });
            Logger.LogError(ex, "Ошибка сохранения уведомления.");
        }
        finally
        {
            loadingSave = false;
            disableSave = false;
            StateHasChanged();
        }
    }

    async Task SaveImageFile(InputFileStream inputFile, string filePath)
    {
        using (var fileStream = System.IO.File.Create(filePath))
        {
            inputFile.Content.Seek(0, SeekOrigin.Begin);
            await inputFile.Content.CopyToAsync(fileStream);
        }
    }

    void Cancel()
    {
        Nav.NavigateTo("/subscription_notifications");
    }

    private static bool IsImageExtension(string extension)
    {
        extension = extension.ToLower();
        string[] imageExtensions = { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".jfif", ".webp" };
        return Array.Exists(imageExtensions, ext => ext == extension);
    }

    public class AddNotificationModel
    {
        public InapType NotificationType { get; set; }
        public string? NotificationTitleUz { get; set; }
        public string? NotificationTitleRu { get; set; }
        public string? NotificationTitleEn { get; set; }
        public string? NotificationDescriptionUz { get; set; }
        public string? NotificationDescriptionRu { get; set; }
        public string? NotificationDescriptionEn { get; set; }
        public string? NotificationImageUrlUz { get; set; }
        public string? NotificationImageUrlRu { get; set; }
        public string? NotificationImageUrlEn { get; set; }
        public bool IsNotificationActive { get; set; }
    }

    public class InputFileStream
    {
        public Stream Content { get; set; }
        public string FileName { get; set; }

        public InputFileStream(Stream content, string fileName)
        {
            Content = content;
            FileName = fileName;
        }
    }
}