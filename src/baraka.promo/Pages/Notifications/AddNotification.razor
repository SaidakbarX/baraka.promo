@page "/push_sender"

@using MediatR;
@using Microsoft.EntityFrameworkCore;
@using Newtonsoft.Json;
@using Telegram.Bot;
@using Telegram.Bot.Exceptions;
@using Telegram.Bot.Types.Enums;
@using Telegram.Bot.Types;
@using Telegram.Bot.Types.ReplyMarkups;
@using baraka.promo.BackgroundService
@using baraka.promo.BackgroundService.BackgroundModels;
@using baraka.promo.Core;
@using baraka.promo.Models.Segment;
@using baraka.promo.Models.TgMessageModel;
@using baraka.promo.Pages.TgPushSender
@using baraka.promo.Services

@inject IJSRuntime jsRuntime
@inject ApplicationDbContext _dbApp
@inject DeliveryDbContext _dbDelivery
@inject NotificationService NotificationService
@inject IMediator _mediator
@inject ILogger<AddNotification> _logger
@inject NavigationManager NavigationManager
@inject TgHelper tgHelper
@inject DialogService dialogService
@inject TasksToRun _tasksToRun
@inject PushService _push_service
@inject IWebHostEnvironment _env


<RadzenMenu Style="display:flex; justify-content:space-between; background-color:lightgray;" @attributes="@(new Dictionary<string, object>() { { "class", "header-menu-btn-toolbar" } })">
    <div style="display:flex; align-items:center; background-color:lightgray; width: 100%; padding: 0px 35px 0px 8px;">
        <span class="header-text">Тип фильтра</span>
        <RadzenSelectBar @bind-Value=@value TValue="bool" Size="ButtonSize.Small" Style="background-color: white; margin-left: 10px;">
            <Items>
                <RadzenSelectBarItem Text="Все" Value="true" />
                <RadzenSelectBarItem Text="Сегмент" Value="false" />
            </Items>
        </RadzenSelectBar>

        @if (!value)
        {
            <div style="display:flex; align-items: center; margin: 10px;">

                <RadzenLabel Text="Сегменты" Component="DropDownMultipleChips" Style="margin-right: 8px; vertical-align: middle;" />
                <RadzenDropDown @bind-Value=@segmentId Data=@segmentList TextProperty="Name" ValueProperty="Id" Name="DropDownMultipleChips"
                                Multiple=false AllowClear=true Placeholder="Выберите сегмент" Chips=true Style="width: 100%; max-width: 400px;" />

            </div>
        }
       
        <div style="flex:1; display: flex; justify-content: end;">
            <RadzenUpload Multiple="false" Auto="true" Style="display:flex; flex-direction:row; margin-right: 10px;" Icon="upload_file" ChooseText="" Accept=".xlsx, .xls, .csv" Change="@OnFileChange" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "select file" }})" />
            <RadzenButton Click="@Refresh" Icon="refresh" ButtonStyle="ButtonStyle.Light" />
        </div>

    </div>
</RadzenMenu>

<div style="display: flex;">
    <RadzenCard Style="display: flex;row-gap: 10px; flex-direction: column; width: 80%;">
        <div>
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Текст UZ</RadzenText>
            <RadzenTextArea Placeholder="Введите текст" Change=@(args => OnChangeTextUz(args, "TextArea with placeholder")) class="w-100" Style="height: 100px" aria-label="TextArea with placeholder" />
        </div>
        <div>
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Текст RU</RadzenText>
            <RadzenTextArea Placeholder="Введите текст" Change=@(args => OnChangeTextRu(args, "TextArea with placeholder")) class="w-100" Style="height: 100px" aria-label="TextArea with placeholder" />
        </div>
        <div>
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Текст EN</RadzenText>
            <RadzenTextArea Placeholder="Введите текст" Change=@(args => OnChangeTextEn(args, "TextArea with placeholder")) class="w-100" Style="height: 100px" aria-label="TextArea with placeholder" />
        </div>
        <div>
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Текст KZ</RadzenText>
            <RadzenTextArea Placeholder="Введите текст" Change=@(args => OnChangeTextKz(args, "TextArea with placeholder")) class="w-100" Style="height: 100px" aria-label="TextArea with placeholder" />
        </div>

        <div class="input-group pt-1 align-items-center">
            <div class="custom-file">
                <InputFile OnChange="@OnInputFileChange" class="custom-file-input" type="file" id="inputGroupFile05" aria-describedby="inputGroupFileAddon05" />
                <label class="custom-file-label" for="inputGroupFile05">@fileName</label>
            </div>
        </div>
        <div style="display: flex; align-items: center;">
            <EditForm Model="@newModel" style="display: flex; column-gap: 10px;">
                <MyInputMask Prefix="+998" data-mask="00 000 00 00" @bind-Value="@newModel.TestPhone" Label="Тестовый номер телефона" />
                @if (disableTime)
                {
                    <div style="margin-left: 20px;">
                        <RadzenLabel Text="Дата начала" Component="DatePickerTimeOnly" Style="margin-right: 8px; vertical-align: middle;" />
                        <RadzenDatePicker @bind-Value=@newModel.StartDate ShowTime="true" DateFormat="MM/dd/yyyy" Style="width: 150px; margin-right: 10px" />

                        <RadzenLabel Text="Режим работы от" Component="DatePickerTimeOnly" Style="margin-right: 8px; vertical-align: middle;" />
                        <RadzenDatePicker @bind-Value=@newModel.TimeFrom ShowTime="true" TimeOnly="true" DateFormat="HH:mm" Style="width: 100px" />

                        <RadzenLabel Text="до" Component="DatePickerTimeOnly" Style="margin-right: 8px; vertical-align: middle;" />
                        <RadzenDatePicker @bind-Value=@newModel.TimeTo ShowTime="true" TimeOnly="true" DateFormat="HH:mm" Style="width: 100px" />
                    </div>
                }

            </EditForm>
            <div style="display: flex; margin-left: auto; column-gap: 10px;">
                @if (loadingSend)
                {
                    <div>
                        <RadzenProgressBarCircular Style="margin-left: 60px" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                    </div>
                }
                <RadzenButton Disabled="@disableSend" Variant="Variant.Flat" Click=@Click Text="Отправить" ButtonStyle="ButtonStyle.Primary" />
            </div>

        </div>

    </RadzenCard>

    <RadzenCard Style="height: 200px; width: 300px; margin-inline-start: auto; background-color: ghostwhite;">
        <RadzenLabel>
            @textInfo
        </RadzenLabel>
    </RadzenCard>

</div>


@code {

    [CascadingParameter]
    public Task<AuthenticationState>? AuthTask { get; set; }

    bool disableSend;
    bool value = true;
    string fileName = "Выберите файл";
    int userCount;
    bool disableTime = true;
    bool loading = false;
    bool loadingSend = false;

    SendModel newModel = new();
    List<SegmentModel> segmentList = new List<SegmentModel>();
    List<TgUserModel> tgUsers = new List<TgUserModel>();
    CancellationTokenSource cts = new CancellationTokenSource();

    //private List<Guid?> selectedRestaurants = new List<Guid?>();

    int segmentId;

    IEnumerable<Product> products;

    private const int TextMaxForImgAndVideo = 1024;
    private const int PhotoMaxSize = 10;
    private const int PhotoMaxPoint = 10000;
    private const int PhotoRatio = 20;
    private const int VideoMaxSize = 50;

    long imageMaxSize = 10240 * 1024;
    long videoMaxSize = 51200 * 1024;
    string extension = "";
    InputFileStream? inputFile;
    string textInfo = "";

    protected async override Task OnInitializedAsync()
    {
        textInfo = $"Кол-во символов (макс:{TextMaxForImgAndVideo}), \n" +
                                $"размер файла (макс:{PhotoMaxSize} MB), \n" +
                                $"разрешение (макс:{PhotoMaxPoint}x{PhotoMaxPoint}), \n" +
                                $"пропорция (макс:{PhotoRatio}x1) \n" +
                                $"Кол-во символов (макс:{TextMaxForImgAndVideo}), \n" +
                                $"размер файла (макс:{VideoMaxSize} MB) \n";

        await GetSegments();

        await Refresh();
    }

    async void OnFileChange(UploadChangeEventArgs args)
    {
        foreach (var file in args.Files)
        {
            try
            {
                long maxFileSize = 10 * 1024 * 1024;
                // read file
                if (file != null)
                {
                    using (var stream = file.OpenReadStream(maxFileSize))
                    {
                        if (file.Name.EndsWith(".xlsx") || file.Name.EndsWith(".xls"))
                        {
                            // Handle Excel files with EPPlus
                            var excelService = new ImportExcel();
                            newModel.Phone = await excelService.GetPhoneNumbersFromExcelAsync(stream);
                        }
                        else if (file.Name.EndsWith(".csv"))
                        {
                            // Handle CSV files
                            var csvService = new ImportExcel();
                            newModel.Phone = await csvService.GetPhoneNumbersFromCsvAsync(stream);
                        }
                    }

                    //await UserCount();
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"{ex.Message}", Duration = 4000 });
            }
        }
    }

    async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            string selectedFileName = "";
            if (file != null)
            {
                selectedFileName = file.Name;
                extension = Path.GetExtension(selectedFileName);
                newModel.IsImage = IsImageExtension(extension);
                StateHasChanged();
            }

            if ((bool)newModel.IsImage)
            {

                if (e.File.Size > imageMaxSize)
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"FileMaxSize {imageMaxSize}", Duration = 4000 });

                    return;
                }
            }
            else
            {
                if (e.File.Size > videoMaxSize)
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"FileMaxSize {videoMaxSize}", Duration = 4000 });

                    return;
                }

            }

            MemoryStream fileStream = new MemoryStream();
            await using (var input = e.File.OpenReadStream(videoMaxSize))
            {
                await input.CopyToAsync(fileStream);
            }

            // Check if the fileStream is non-empty before proceeding
            fileStream.Position = 0;
            if (fileStream.Length > 0)
            {
                selectedFileName = $"{Guid.NewGuid()}{extension}".Replace("-", "").ToLower();
                inputFile = new InputFileStream(fileStream, selectedFileName);

            }
            else
            {
                _logger.LogError("File is empty or not read property.");
            }
            fileName = selectedFileName ?? "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"{ex.Message}", Duration = 4000 });
            _logger.LogError(ex.Message, ex);
        }
    }

    async Task GetSegments()
    {
        var list = await _dbApp.Segments.ToListAsync();

        segmentList = list.Select(a => new SegmentModel { Id = a.Id, Name = a.Name }).ToList();
        StateHasChanged();
    }
    async Task LoadSegmentUsers()
    {
        try
        {
            var filter = new SegmentUserFilterModel()
                {
                    Id = segmentId
                };
            var command = new GetSegmentUsers.Command(filter, true);
            var result = await _mediator.Send(command);

            if (result.Data != null)
            {
                //userCount = result.Data.TotalCount;
                newModel.Phone = result.Data.Value;

                var clients = await _dbDelivery.Customers.Where(x => newModel.Phone.Contains(x.Phone1)).Select(y=>y.Id).ToListAsync();

                var clients_devices = await _dbDelivery.CustomerDevices.Where(x => clients.Contains(x.CustomerId)).Select(c => new DeviceModel
                    {
                        DeviceId = c.DeviceId,
                        Language = c.Customer.Language,
                    }).ToListAsync();

                newModel.Devices = clients_devices;

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"{ex.Message}", Duration = 4000 });
        }
        StateHasChanged();
    }

    async void Click()
    {
        await Refresh();
        await Task.Run(Send);
    }

    async Task Send()
    {
        await InvokeAsync(async () =>
        {
            loadingSend = true;
            disableSend = true;

            StateHasChanged();

            await Refresh();
        });

        if (!string.IsNullOrEmpty(newModel.TestPhone))
        {
            var testPhone = ("998" + newModel.TestPhone).Replace(" ", "");
            var client = await _dbDelivery.Customers.FirstOrDefaultAsync(x => x.Phone1 == testPhone || x.Phone2 == testPhone) ?? new Customer();
            var client_device = await _dbDelivery.CustomerDevices.OrderByDescending(x=>x.CreatedTime).FirstOrDefaultAsync(x => x.CustomerId == client.Id);
            if (client_device == null)
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"User not found {testPhone}", Duration = 4000 });

            else
            {
                if (client.Language == Models.Enums.Language.Uz) await _push_service.Send(new List<CustomerDevice> { client_device }, newModel.MessageUz, null, 0);
                else if (client.Language == Models.Enums.Language.Ru) await _push_service.Send(new List<CustomerDevice> { client_device }, newModel.MessageRu, null, 0);
                else if (client.Language == Models.Enums.Language.En) await _push_service.Send(new List<CustomerDevice> { client_device }, newModel.MessageEn, null, 0);
                else if (client.Language == Models.Enums.Language.Kz) await _push_service.Send(new List<CustomerDevice> { client_device }, newModel.MessageKz, null, 0);
            }

            await InvokeAsync(() =>
            {
                loadingSend = false;
                disableSend = false;
                StateHasChanged();

            });
        }
        else
        {
            var model = new SendModel
                {
                    IsImage = newModel.IsImage,
                    SegmentId = value ? segmentId : null,
                    MessageUz = newModel.MessageUz,
                    MessageKz = newModel.MessageKz,
                    MessageRu = newModel.MessageRu,
                    MessageEn = newModel.MessageEn,
                    TestPhone = newModel.TestPhone,
                    TimeFrom = newModel.TimeFrom,
                    TimeTo = newModel.TimeTo,
                    Devices = newModel.Devices,
                };

            try
            {
                if(inputFile != null)
                {
                    string folderPath = Path.Combine(_env.WebRootPath, "img");

                    if (!Directory.Exists(folderPath))
                    {
                        Directory.CreateDirectory(folderPath);
                    }

                    string filePath = Path.Combine(folderPath, inputFile.FileName);

                    using (var fileStream = System.IO.File.Create(filePath))
                    {
                        inputFile.Content.Seek(0, SeekOrigin.Begin);
                        inputFile.Content.CopyTo(fileStream);
                    }

                    model.ImagePath = inputFile.FileName;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex.Message, ex);
            }

            await SaveToDatabase(model);

            await InvokeAsync(() =>
            {
                loadingSend = false;
                disableSend = false;
                StateHasChanged();

            });

            NavigationManager.NavigateTo("/notifications");
        }
    }

    async Task Refresh()
    {
        loading = true;
        if (value)
        {
            await GetClients();
        }
        else
        {
            await LoadSegmentUsers();
        }

        //await UserCount();

        loading = false;
        StateHasChanged();
    }

    async Task GetClients()
    {
        var users = await (from d in _dbDelivery.Customers
                           join c in _dbDelivery.CustomerDevices on d.Id equals c.CustomerId
                           select new DeviceModel
                           {
                               DeviceId = c.DeviceId,
                               Language = d.Language,
                           }).ToListAsync();

        newModel.Devices = users;
        StateHasChanged();
    }

    // Task UserCount()
    // {
    //     userCount = tgHelper.GetClientCount(newModel.Phone, valueUz, valueRu, valueEng, false).Result;
    //     StateHasChanged();

    //     tgUsers = tgHelper.GetClients(newModel.Phone, valueUz, valueRu, valueEng, false).Result;
    //     StateHasChanged();

    //     return Task.CompletedTask;
    // }

    void OnChangeTextUz(string value, string name)
    {
        newModel.MessageUz = value;
        StateHasChanged();
    }
    void OnChangeTextRu(string value, string name)
    {
        newModel.MessageRu = value;
        StateHasChanged();
    }
    void OnChangeTextEn(string value, string name)
    {
        newModel.MessageEn = value;
        StateHasChanged();
    }
    void OnChangeTextKz(string value, string name)
    {
        newModel.MessageKz = value;
        StateHasChanged();
    }

    private static bool IsImageExtension(string extension)
    {
        extension = extension.ToLower();
        string[] imageExtensions = { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".jfif" };
        return Array.Exists(imageExtensions, ext => ext == extension);
    }

    private static bool IsVideoExtension(string extension)
    {
        extension = extension.ToLower();
        string[] videoExtensions = { ".mp4", ".avi", ".mkv", ".mov" };
        return Array.Exists(videoExtensions, ext => ext == extension);
    }

    async Task SaveToDatabase(SendModel model)
    {
        try
        {
            var guid = Guid.NewGuid();

            await _dbApp.NotificationHeaders.AddAsync(new NotificationHeader
                {
                    Id = guid,
                    IsImage = model.IsImage,
                    MessageUz = model.MessageUz,
                    MessageKz = model.MessageKz,
                    MessageRu = model.MessageRu,
                    MessageEn = model.MessageEn,
                    SegmentId = model.SegmentId,
                    WorkingTimeFrom = model.TimeFrom,
                    WorkingTimeTo = model.TimeTo,
                    Status = Models.MessageHeaderStatus.New,
                    CreatedTime = DateTime.Now,
                    CreatedBy = AuthTask?.Result.User.Identity?.Name,
                    StartDate = model.StartDate >= DateTime.Today ? model.StartDate : DateTime.Today,
                    ImagePath = model.ImagePath,
                });

            await _dbApp.SaveChangesAsync();

            _tasksToRun.Enqueue(TaskSettings.FromDeviceMonitorSettings(new BackgroundService.DeviceSettingsModel
                {
                    Devices = model.Devices,
                    NotificationHeaderId = guid
                }));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex.Message, ex);
        }
        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

    string GetFileType(string fileName)
    {
        string extension = Path.GetExtension(fileName)?.ToLower();

        if (extension == ".jpg" || extension == ".jpeg" || extension == ".png" || extension == ".gif")
        {
            return "Image";
        }
        else if (extension == ".mp4" || extension == ".avi" || extension == ".mkv" || extension == ".mov")
        {
            return "Video";
        }
        else
        {
            return "Unknown";
        }
    }

    class SegmentModel
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
    class SendModel
    {
        public DateTime StartDate { get; set; }
        public DateTime TimeFrom { get; set; }
        public DateTime TimeTo { get; set; }
        public string? FileId { get; set; }
        public int? SegmentId { get; set; }
        public List<string> Phone { get; set; }
        public string? MessageUz { get; set; }
        public string? MessageRu { get; set; }
        public string? MessageEn { get; set; }
        public string? MessageKz { get; set; }
        public bool? IsImage { get; set; }
        public string? TestPhone { get; set; }
        public List<DeviceModel> Devices { get; set; }
        public string ImagePath { get; set; }
    }

    class RestaurantModel
    {
        public Guid Id { get; set; }
        public string? Name { get; set; }
    }
}
