@using Microsoft.AspNetCore.Components.Web
@namespace baraka.promo.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="~/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link href="css/site.css" rel="stylesheet" />
    <link href="baraka.promo.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css">
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/standard-base.css">
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    @RenderBody()

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            An error has occurred. This application may no longer respond until reloaded.
        </environment>
        <environment include="Development">
            An unhandled exception has occurred. See browser dev tools for details.
        </environment>
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.server.js"></script>
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
    <script src="imask.min.js"></script>
    <script src="javascript/iMask.js"></script>
    <script src="javascript/Mask.js"></script>
    <script>

        $(document).on('click', '.dropdown-menu a.dropdown-toggle', function (e) {
            if (!$(this).next().hasClass('show')) {
                $(this).parents('.dropdown-menu').first().find('.show').removeClass("show");
            }
            var $subMenu = $(this).next(".dropdown-menu");
            $subMenu.toggleClass('show');

            $(this).parents('li.nav-item.dropdown.show').on('hidden.bs.dropdown', function (e) {
                $('.dropdown-submenu .show').removeClass("show");
            });

            return false;
        });

        window.myscroll = (css) => {
            //alert('setScrollByCss -> ' + css);
            if ($(css).length > 0) {
                $(css).mCustomScrollbar({
                    scrollInertia: 1000,
                    scrollbarPosition: "inside",
                    advanced: { updateOnContentResize: true }
                });
            }
        };

        window.scrollToBottom = (id) => {
            var height = $('#' + id).height();
            $('#' + id + '> div').each(function () {
                height += $(this).height();
            });

            //var height = 518888 + 185 + 300; //$('#' + id).height();
            console.log("scrollToBottom table and divs height:", height);
            var scrollBottom = Math.max(height, 0);
            console.log("scrollToBottom scrollBottom:", scrollBottom);
            $('#' + id).scrollTop(scrollBottom);

        };

        window.console_log = (text, value) => {
            console.log(text, value);
        };

        window.getElementHeight = (id) => {
            console.log('getElementHeight id:', id);
            if (id != undefined && !id.startsWith('#'))
                id = '#' + id;
            var height = $(id).height();
            console.log('getElementHeight', height);
            if (height != undefined)
                return height;
            else
                return 0;
        };

        window.mask = (id, mask, isupper) => {
            console.log('mask -> ' + id);
            if (mask != undefined && mask.length > 0) {
                if (isupper != undefined && isupper) {
                    var customMask = IMask(
                        document.getElementById(id), {
                        mask: mask,
                        prepare: function (str) {
                            return str.toUpperCase();
                        },
                        commit: function (value, masked) {
                            masked._value = value.toUpperCase();
                        }
                    });
                }
                else {
                    var customMask = IMask(
                        document.getElementById(id), {
                        mask: mask
                    });
                }
            }
        };
        window.mask_by_css = (css, mask) => {
            var items = document.getElementsByClassName(css);

            Array.prototype.forEach.call(items, function (element) {
                var customMask = new IMask(element, {
                    mask: mask,
                    prepare: function (str) {
                        return str.toUpperCase();
                    },
                    commit: function (value, masked) {
                        // Don't change value manually! All changes should be done in mask!
                        // This example helps to understand what is really changes, only for demo
                        masked._value = value.toUpperCase();  // Don't do it
                    }
                });
            });

            //var customMask = IMask(
            //    document.getElementById(id), {
            //    mask: mask
            //});
        };
        window.setElementFocusById = function (id) {
            console.log("window.setElementFocusById id=" + id);
            $("#" + id).focus();
            //document.getElementById(id).focus();
        };
        window.setElementFocusByIdTimer = function (id) {
            setTimeout(function () { window.setElementFocusById(id); }, 100);
        };

        window.initCarousel = (elementId, nextBtnId, prevBtnId) => {
            $(elementId).carousel({ interval: false });
            $(prevBtnId).click(
                () => {
                    console.log("carousel prev click");
                    $(elementId).carousel('prev');
                });
            $(nextBtnId).click(
                () => {
                    console.log("carousel next click");
                    $(elementId).carousel('next');
                });
        };

        window.carouselCommand = (elementId, command) => {
            console.log("carousel prev " + command);
            $(elementId).carousel(command);
        };

        window.carouselGoTo = (elementId, number, timer) => {
            if (timer) {
                setTimeout(function () { $(elementId).carousel(number); }, 1000);
            }
            else {
                $(elementId).carousel(number);
            }
        };

        window.setHeight100ByTop = (elementId) => {
            var el = $(elementId);
            var offset = el.offset();
            console.log("setHeight100ByTop offset: ", offset);
            var eTop = offset.top;
            eTop += 50;
            el.css({ height: 'calc(100vh - ' + eTop + 'px)' });;
        };

        function BlazorDownloadFileFast(name, contentType, content) {
            // Convert the parameters to actual JS types
            const nameStr = BINDING.conv_string(name);
            const contentTypeStr = BINDING.conv_string(contentType);
            const contentArray = Blazor.platform.toUint8Array(content);

            // Create the URL
            const file = new File([contentArray], nameStr, { type: contentTypeStr });
            const exportUrl = URL.createObjectURL(file);

            // Create the <a> element and click on it
            const a = document.createElement("a");
            document.body.appendChild(a);
            a.href = exportUrl;
            a.download = nameStr;
            a.target = "_self";
            a.click();

            // We don't need to keep the url, let's release the memory
            // On Safari it seems you need to comment this line... (please let me know if you know why)
            URL.revokeObjectURL(exportUrl);
        }

        function BlazorDownloadFile(filename, contentType, content) {
            // Blazor marshall byte[] to a base64 string, so we first need to convert the string (content) to a Uint8Array to create the File
            const data = base64DecToArr(content);

            // Create the URL
            const file = new File([data], filename, { type: contentType });
            const exportUrl = URL.createObjectURL(file);

            // Create the <a> element and click on it
            const a = document.createElement("a");
            document.body.appendChild(a);
            a.href = exportUrl;
            a.download = filename;
            a.target = "_self";
            a.click();

            // We don't need to keep the url, let's release the memory
            // On Safari it seems you need to comment this line... (please let me know if you know why)
            URL.revokeObjectURL(exportUrl);
        }

        // Convert a base64 string to a Uint8Array. This is needed to create a blob object from the base64 string.
        // The code comes from: https://developer.mozilla.org/fr/docs/Web/API/WindowBase64/D%C3%A9coder_encoder_en_base64
        function b64ToUint6(nChr) {
            return nChr > 64 && nChr < 91 ? nChr - 65 : nChr > 96 && nChr < 123 ? nChr - 71 : nChr > 47 && nChr < 58 ? nChr + 4 : nChr === 43 ? 62 : nChr === 47 ? 63 : 0;
        }

        function base64DecToArr(sBase64, nBlocksSize) {
            console.log("sBase64:", sBase64);
            var
                sB64Enc = sBase64.replace(/[^A-Za-z0-9\+\/]/g, ""),
                nInLen = sB64Enc.length,
                nOutLen = nBlocksSize ? Math.ceil((nInLen * 3 + 1 >> 2) / nBlocksSize) * nBlocksSize : nInLen * 3 + 1 >> 2,
                taBytes = new Uint8Array(nOutLen);

            for (var nMod3, nMod4, nUint24 = 0, nOutIdx = 0, nInIdx = 0; nInIdx < nInLen; nInIdx++) {
                nMod4 = nInIdx & 3;
                nUint24 |= b64ToUint6(sB64Enc.charCodeAt(nInIdx)) << 18 - 6 * nMod4;
                if (nMod4 === 3 || nInLen - nInIdx === 1) {
                    for (nMod3 = 0; nMod3 < 3 && nOutIdx < nOutLen; nMod3++, nOutIdx++) {
                        taBytes[nOutIdx] = nUint24 >>> (16 >>> nMod3 & 24) & 255;
                    }
                    nUint24 = 0;
                }
            }
            return taBytes;
        }

        window.openInNewTab = (url) => {
            if (!url.startsWith("data:image"))
                url = url.replace('\\', '/');
            console.log("openInNewTab url", url);
            var newTab = window.open();
            newTab.document.body.style = "margin: 0px; background: #0e0e0e; height: 100%";
            newTab.document.body.innerHTML = '<img style="-webkit-user-select: none;margin: auto;background-color: hsl(0, 0%, 90%);transition: background-color 300ms;" src="' + url + '">';
        };
    </script>
    <script src="javascript/ExcelFunc.js"></script>
    <script src="javascript/CopyFunc.js"></script>
</body>
</html>

